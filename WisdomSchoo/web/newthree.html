<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>test</title>
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="stylesheet" href="./assects/bootstrap-3.3.7-dist/css/bootstrap.css">
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_597570_8dlcvxfnv10grpb9.css">
    <script src="http://10.12.12.201:8181/socket.io/socket.io.js" charset="utf-8"></script>
    <script type="text/javascript" src="./assects/js/jquery.js"></script>
    <script type="text/javascript" src="./assects/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
    <!--<link rel="stylesheet" href="assects/js/arcgis_js_v46_api/arcgis_js_api/library/4.6/esri/css/main.css">
    <script src="assects/js/arcgis_js_v46_api/arcgis_js_api/library/4.6/init.js"></script>-->
    <link rel="stylesheet" href="assects/js/arcgis_js_v45_api/arcgis_js_api/library/4.5/esri/css/main.css">
    <script src="assects/js/arcgis_js_v45_api/arcgis_js_api/library/4.5/init.js"></script>
    <<!--link rel="stylesheet" href="index.css">-->
    <!--<script src="index.js"></script>-->
</head>
<style>
    html,
    body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
    }

    #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
    }

    #search {
        position: absolute;
        top: 25px;
        width: 250px;
        height: 40px;
        box-shadow: 2px 2px 2px #f5f5f5;

    }

    #daohang {
        position: absolute;
        background-color: #f9f9f9;
        top: 25px;
        left: 250px;
        width: 40px;
        height: 40px;
    -webkit-gradient(linear, 0 % 0 %, 0 % 0 %, from(#F7F2F5), to(#333333), color-stop(1.0, #F7FAEE)) box-shadow: 2 px 2 px 2 px #f5f5f5;
    }

    #daohangonetoone {
        position: absolute;
        background-color: #2aabd2;
        top: 65px;
        width: 290px;
        height: 300px;
        display: none;
    }

    .fontdh {
        position: relative;
        top: -13px;
        left: -13px;
        font-size: 40px;
        cursor: pointer;
        box-shadow: 2px 2px 2px #f5f5f5;
    }

    #clock {
        position: absolute;
        top: 25px;
        left: 300px;
        width: 150px;
        height: 40px;
        font-size: 23px;
        display: inline-block;
        text-align: center;
        vertical-align: middle;
    -webkit-gradient(linear, 0 % 0 %, 0 % 0 %, from(#F7F2F5), to(#333333), color-stop(1.0, #F7FAEE)) box-shadow: 2 px 2 px 2 px #f5f5f5;

    }

    #txt {
        font-size: 32px;
        color: #fff;
        font-family: Microsoft Yahei;
        width: 150px;
        height: 40px;
    }

    #daohanglan {
        position: absolute;
        top: 25px;
        right: 50px;
        width: 560px;
        height: 40px;
        display: flex;
        flex-direction: row;
        font-size: 20px;
        text-align: center;
        background-color: white;
        box-shadow: 2px 2px 2px #f5f5f5;
    }

    #home {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
    }

    #edtsd {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
    }

    #jiagai {
        position: relative;
        display: none;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;

    }

    #intro {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
    }

    #bianqian {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
    }

    #shaixuan {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
    }

    #gaoliang {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
        float: left;
    }

    #tianjia {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
        float: left;
    }

    #jianshao {
        position: relative;
        width: 70px;
        border-right: 1px solid #000000;
        font-size: 15px;
        vertical-align: middle;
        cursor: pointer;
        overflow: visible;
        zoom: 1;
        color: #5f6477;
        float: left;
    }

    #login p {
        position: absolute;
        top: 25px;
        right: 0px;
        width: 50px;
        height: 40px;
        font-size: 40px;
        border-radius: 30px;
    }

    .loginicon {
        position: relative;
        top: -7px;
        font-size: 40px;
    }

    /*#loginspace{
        position: absolute;
        top:65px;
        right: 0px;
        width: 80px;
        height: 100%;
        background-color: blue;
    }*/
    .modal-dialog {
        margin: 200px auto;
    }

    #overviewDiv {
        position: absolute;
        bottom: 5px;
        left: 5px;
        width: 250px;
        height: 150px;
    }

    #tourtext {
        position: absolute;
        bottom: 5px;
        left: 50%;
        width: 300px;
        height: 100px;
        font-size: 20px;
    }

    #slide {
        position: absolute;
        display: none;
        top: 65px;
        right: 5px;
        height: 400px;
        width: 250px;
    }

    #createSlideDiv {
        background-color: white;
        opacity: 0.9;
        color: black;
        padding: 6px;
    }

    #slidesDiv {
        background-color: white;
        opacity: 0.9;
        color: black;
        padding: 10px;
        visibility: hidden;
        bottom: 20px;
        overflow-y: auto;
        text-align: center;
        height: 260px;
    }

    #slidesDiv .slide {
        /* Show cursor as pointer when on a slide */
        cursor: pointer;
        margin-bottom: 6px;
    }

    #slidesDiv .slide .title {
        /* Center the title text */
        text-align: center;
    }

    /* Draw active slide with a nice border around the thumbnail */

    #slidesDiv .slide.active img {
        box-shadow: 0px 0px 12px black;
        border-style: solid;
        border-width: thin;
        border-color: black;
    }

    #optionsDiv {
        position: absolute;
        display: none;
        top: 65px;
        left: 5px;
        width: 300px;
        height: 100px;
    }

    #shaixuanright {
        position: absolute;
        display: none;
        top: 65px;
        right: 5px;
        width: 300px;
        height: 210px;

    }

    #shaixuanlend {
        display: none;
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 300px;
        height: 300px;
    }

    #gaolianglist {
        display: none;
    }

    .panel-side {
        width: 200px;
        position: absolute;
        top: 65px;
        right: 5px;
        bottom: 28px;
        color: #323232;
        background-color: rgb(255, 255, 255);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        overflow: auto;
        z-index: 60;
        font-size: 12px;
        text-align: center;
    }

    .panel-side h2 {
        padding: 0 20px;
        margin: 20px 0;
        font-size: 14px;
        font-weight: 600;
    }

    .panel-side ul {
        list-style: none;
        margin: 0;
        padding: 0;
        font-weight: 100;
    }

    .panel-side li {
        list-style: none;
        padding: 3px 10px;
    }

    .panel-result {
        cursor: pointer;
        margin: 2px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
        background-color: rgba(200, 200, 200, 0.6);
    }


</style>
<script>
    require([
        "esri/Map",
        "esri/views/SceneView",
        "esri/views/MapView",
        "esri/widgets/Search",
        "esri/WebScene",
        /*"esri/widgets/Directions",*/
        "esri/core/urlUtils",
        "esri/core/watchUtils",
        "dojo/dom",
        "dojo/promise/all",
        "esri/widgets/Sketch/SketchViewModel",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "dojo/query",
        "dojo/on",
        "esri/Camera",
        "esri/webscene/Slide",
        "dojo/dom-construct",
        "dojo/dom-class",
        "esri/widgets/Legend",
        "esri/widgets/LayerList",
        "esri/tasks/support/Query",
        "esri/layers/FeatureLayer",
        "dojo/domReady!"
    ], function (Map,
                 SceneView,
                 MapView,
                 Search,
                 WebScene,
                 /*Directions,*/
                 urlUtils,
                 watchUtils,
                 dom,
                 all,
                 SketchViewModel,
                 Graphic,
                 GraphicsLayer,
                 query,
                 on,
                 Camera,
                 Slide,
                 domConstruct,
                 domClass,
                 Legend,
                 LayerList,
                 Query, FeatureLayer) {
//////websocket
        point = {
            type: "point", // autocasts as new Point()
            z: 1010
        };
        markerSymbol = {
            type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
            color: [226, 119, 40],
            outline: { // autocasts as new SimpleLineSymbol()
                color: [255, 255, 255],
                width: 2
            }
        };

        var longtitude;
        var latitude;
        var AAPLnum;
        var MSFTnum;
        var point;
        var pointGraphic = new Graphic();
        /*  var ws = new WebSocket("ws://localhost:8181");*/
        var stock_request = {"stocks": ["AAPL", "MSFT", "AMZN", "GOOG", "YHOO"]};
        var isClose = false;
        var stocks = {
            "AAPL": 120.0480687618, "MSFT": 30.2303164712, "AMZN": 0, "GOOG": 0, "YHOO": 0
        };
       /* function updataUI() {
         ws.onopen = function (e) {
         console.log('Connection to server opened');
         isClose = false;
         ws.send(JSON.stringify(stock_request));
         console.log("sened a mesg");
         }
         // UI update function
         var changeStockEntry = function (symbol, originalValue, newValue) {
         var valElem = $('#' + symbol + ' span');
         valElem.html(newValue.toFixed(2));
         if (newValue < originalValue) {
         valElem.addClass('label-danger');
         valElem.removeClass('label-success');
         } else if (newValue > originalValue) {
         valElem.addClass('label-success');
         valElem.removeClass('label-danger');
         }
         };
         var graphicsLayer = new GraphicsLayer();
         // WebSocket message handler
         ws.onmessage = function (e) {
         ///数据传输存入stickData
         var stocksData = JSON.parse(e.data);
         setInterval(function () {
         graphicsLayer.add(pointGraphic);
         map.add(graphicsLayer);
         /!*AAPLnum = document.getElementById("AAPLnum");*!/
         AAPLnum = stocksData["AAPL"];
         /!*MSFTnum = document.getElementById("MSFTnum");*!/
         MSFTnum = stocksData["MSFT"];
         /!*console.log(stocksData);
         console.log('1111111111111111'+AAPLnum.innerHTML);
         console.log(typeof (parseFloat(AAPLnum.innerHTML)));
         console.log('1111111111111111'+MSFTnum.innerHTML);
         console.log(typeof (parseFloat(MSFTnum.innerHTML)));*!/
         /!*longtitude = parseFloat(AAPLnum.innerHTML);
         latitude = parseFloat(MSFTnum.innerHTML);*!/
         console.log("AAPLnum:"+AAPLnum);
         console.log("MSFTnum:"+MSFTnum);
         longtitude = parseFloat(AAPLnum);
         console.log("longtitude:"+longtitude);
         latitude = parseFloat(MSFTnum);
         point.longtitude=longtitude;
         point.latitude=latitude;
         pointGraphic.geometry=point;
         graphicsLayer.load();
         pointGraphic.symbol= markerSymbol;
         },2000);
         graphicsLayer.remove(pointGraphic);
         map.remove(graphicsLayer);
         /!*graphicsLayer.watch("pointGraphic.geometry.point",function () {
         })*!/
         for (var symbol in stocksData) {
         if (stocksData.hasOwnProperty(symbol)) {
         changeStockEntry(symbol, stocks[symbol], stocksData[symbol]);
         stocks[symbol] = stocksData[symbol];
         }
         }
         };
         };*/

         //updataUI();


        /* let sock = io.connect('ws://10.12.12.201:8181/');*/
        window.onload = function () {
            sock.emit('query');
            on(dom.byId("tianjia"), "click", function (evt) {
                sock.emit('tianjia');
            });
            on(dom.byId("jianshao"), "click", function (evt) {
                sock.emit('jianshao');
            });
        };
        /////
        var map = new Map({
            basemap: "streets",
            ground: "world-elevation",
            slider: false,
            logo: false
        });

        var overviewMap = new Map({
            basemap: "osm"
        });
        var tempGraphicsLayer = new GraphicsLayer();
        var mapView = new MapView({
            container: "overviewDiv",
            map: overviewMap,
            layer: [tempGraphicsLayer]
        });

        mapView.ui.components = [];

        var extentDiv = dom.byId("extentDiv");

        var scene = new WebScene({
            portalItem: {
                id: "938b2a957d254417869569116e2c6c10"
            }
        });
        var view = new SceneView({
            container: "viewDiv",
            map: scene,
            heading: 90, // face due east
            tilt: -120,
            center: [120.033348, 30.2283141],
            scale: 3000,
            environment: {
                atmosphere: { // creates a realistic view of the atmosphere
                    quality: "high"
                },
                lighting: {
                    date: new Date(),
                    directShadowsEnabled: true,
                    // don't update the view time when user pans.
                    // The clock widget drives the time
                    cameraTrackingEnabled: false
                }
            },
            highlightOptions: {
                color: [0, 255, 255],
                fillOpacity: 0.6
            },
        });
        var highlight = null;
        var searchWidget = new Search({
            view: view,
            container: "search"
        });
        view.ui.empty("top-left");
        //var timeField = document.getElementById("clock");
        var tourtext = document.getElementById("tourtext");

        var renderer = {
            type: "simple", // autocasts as new SimpleRenderer()
            symbol: {
                type: "polygon-3d", // autocasts as new PolygonSymbol3D()
                symbolLayers: [{
                    type: "extrude" // autocasts as new ExtrudeSymbol3DLayer()
                }]
            },
            visualVariables: [{
                type: "size",
                field: "state",
                stops: [
                    {
                        value: 1,
                        size: 2,
                        label: "1,000"
                    },
                    {
                        value: 0,
                        size: 0,
                        label: ">150,000"
                    }]
            }]
        };
        var zhuozilayer = new FeatureLayer({
            url: "http://10.12.12.201/arcgis/rest/services/postgis_23_sample_postgres_desk/FeatureServer/0",
            renderer: renderer,
            elevationInfo: {
                mode: "relative-to-ground",
                offset: 5,
                unit: "meters"
            }
        });
        scene.add(zhuozilayer);

        /*var updateTimefield = function() {
         timeField.innerHTML = view.environment.lighting.date.toLocaleString();

         };*/

        urlUtils.addProxyRule({
            urlPrefix: "route.arcgis.com",
            proxyUrl: "/sproxy/"
        });
        /*var directionsWidget = new Directions({
         view: mapView,
         container:"daohangonetoone"
         });*/
        //时间
        /*setInterval(function (time) {
         view.environment.lighting.date = time;
         updateTimefield();
         console.log(time)
         },1000)*/
        function createSlideUI(slide, placement) {
            /*********************************************************************
             * Create a new <div> element which contains all the slide information.
             * Store a reference to the created DOM node so we can use it to place
             * other DOM nodes and connect events.
             *********************************************************************/
            var slideElement = domConstruct.create("div", {
                // Assign the ID of the slide to the <span> element
                id: slide.id,
                className: "slide"
            });

            /*********************************************************************
             * Place the newly created DOM node at the beginning of the slidesDiv
             *********************************************************************/
            var position = placement ? placement : "last";
            domConstruct.place(slideElement, "slidesDiv", position);

            /*********************************************************************
             * Create a <div> element to contain the slide title text
             *********************************************************************/
            domConstruct.create("div", {
                // Place the title of the slide in the <div> element
                textContent: slide.title.text,
                className: "title"
            }, slideElement);

            /*********************************************************************
             * Create a new <img> element and place it inside the newly created slide
             * element. This will reference the thumbnail from the slide.
             *********************************************************************/
            domConstruct.create("img", {
                // Set the src URL of the image to the thumbnail URL of the slide
                src: slide.thumbnail.url,

                // Set the title property of the image to the title of the slide
                title: slide.title.text
            }, slideElement); // Place the image inside the new <div> element

            /*********************************************************************
             * Set up a click event handler on the newly created slide. When clicked,
             * the code defined below will execute.
             *********************************************************************/
            on(slideElement, "click", function () {
                /*******************************************************************
                 * Remove the "active" class from all elements with the .slide class
                 *******************************************************************/
                query(".slide").forEach(function (node) {
                    domClass.remove(node, "active");
                });

                /*******************************************************************
                 * Add the "active" class on the current element being selected
                 *******************************************************************/
                domClass.add(slideElement, "active");

                /******************************************************************
                 * Applies a slide's settings to the SceneView.
                 *
                 * Each slide has a viewpoint and visibleLayers property that define
                 * the point of view or camera for the slide and the layers that should
                 * be visible to the user when the slide is selected. This method
                 * allows the user to animate to the given slide's viewpoint and turn
                 * on its visible layers and basemap layers in the view.
                 ******************************************************************/
                slide.applyTo(view);
            });
        }
        var graphicLayer = new GraphicsLayer();
        var pointGraphic = new Graphic();
        var point={type:"point",
        z:1010};
        var markerSymbol = {
            type:"simple-marker",
            color:[226,119,40],
            outline:{
                color:[255,255,255],
                width:2
            }
        };
        setInterval(function () {
            graphicLayer.add(pointGraphic);
            var lat=document.getElementById('lat');

            var long=document.getElementById('long');
            var height=document.getElementById('height');

            console.log("zzzzzzzzzzzzzzzzzzzz"+lat);
            console.log("kkkkkkkkkkkkkkkkkkkk"+long.innerHTML);
            console.log("kkkkkkkkkkkkkkrrrrrrrrrrr"+height.innerHTML);
            graphicLayer.add(pointGraphic);
            scene.add(graphicLayer);
            longtitude = parseFloat(long);
            latitude = parseFloat(lat);
            point.longitude = longtitude;
            point.latitude = latitude;
            pointGraphic.geometry = point;
            graphicLayer.load();
            pointGraphic.symbol = markerSymbol;
        },2000);
        setInterval(function () {
            graphicLayer.remove(pointGraphic);
            scene.remove(graphicLayer);
        },3000);


        view.then(function () {
            console.log(view.extent);
            view.goTo({
                    heading: -30, // face due east
                    tilt: 90,
                    center: [120.0421357155, 30.2335793886],
                        /*center:[120.0304024676,30.2287129350],*/
                    scale: 3000,
                },
                {
                    animate: true,
                    duration: 100000
                });
            mapView.then(function () {
                view.goTo({
                    heading: 0, // face due east
                    tilt: 80,
                    center: [120.0421357155, 30.2335793886],
                    /*center:[120.0304024676,30.2287129350],*/
                    scale: 3000,
                });

                view.watch("extent", updateOverviewExtent);
                mapView.watch("extent", updateOverviewExtent);

                watchUtils.when(view, "stationary", updateOverview);

                function updateOverview() {
                    mapView.goTo({
                        center: view.center,
                        scale: view.scale * 1 * Math.max(view.width /
                            mapView.width,
                            view.height / mapView.height)
                    });
                }

                function updateOverviewExtent() {
                    var extent = view.extent;
                    var bottomLeft = mapView.toScreen(extent.xmin, extent.ymin);
                    var topRight = mapView.toScreen(extent.xmax, extent.ymax);

                    extentDiv.style.top = topRight.y + "px";
                    extentDiv.style.left = bottomLeft.x + "px";

                    extentDiv.style.height = (bottomLeft.y - topRight.y) + "px";
                    extentDiv.style.width = (topRight.x - bottomLeft.x) + "px";
                };

            });


            /*********************************************************************
             标签
             *********************************************************************/
            dom.byId("slidesDiv").style.visibility = "visible";
            var slides = scene.presentation.slides;
            slides.forEach(createSlideUI);
            on(dom.byId("createSlideButton"), "click", function () {
                Slide.createFrom(view).then(function (slide) {
                    slide.title.text = dom.byId("createSlideTitleInput")
                        .value;
                    scene.presentation.slides.add(slide);
                    createSlideUI(slide, "first");
                });
            });

            /*********************************************************************
             高亮
             *********************************************************************/
            var officeSceneLayer = scene.allLayers.filter(function (elem) {
                return elem.title === "rooms1";
            }).items[0];
            console.log("officeSceneLayer:" + officeSceneLayer);
            console.log(officeSceneLayer);

            // Get DOM element where list items will be placed
            var container = document.getElementById("roomsList");

            // Highlight is set on the layerView, so we need to detect when the layerView is ready
            view.whenLayerView(officeSceneLayer).then(function (officeLayerView) {

                // Wait for the layer view to finish updating
                officeLayerView.watch("updating", function (val) {
                    if (!val) {
                        // Query the features available for drawing and get all the attributes


                        officeLayerView.queryFeatures().then(
                            function (result) {
// Empty the list DOM element
                                container.innerHTML = "";
                                // For each returned feature that is of type office create a list item and append it to the container
                                result.forEach(function (feature) {
                                    var attributes = feature.attributes;
                                    console.log(result.features)
                                    console.log(attributes)
                                    // We only want to add features of type Office to the list
                                    if (attributes.room_number !== null) {
                                        // Create list element
                                        var li = document.createElement(
                                            "li");
                                        li.setAttribute("class",
                                            "panel-result");
                                        li.innerHTML = "Room " + attributes.room_number;
                                        li.addEventListener("click",
                                            function (evt) {
                                                var target = evt.target;
                                                var objectId = feature.attributes.objectid;
                                                // Create an extent query on the layer view that will return the 3D extent of the feature
                                                var queryExtent = new Query({
                                                    objectIds: [objectId]
                                                });
                                                officeLayerView.queryExtent(
                                                    queryExtent).then(
                                                    function (result) {
                                                        // Zoom to the extent of the feature
                                                        // Use the expand method to prevent zooming in too close to the feature
                                                        view.goTo(result.extent
                                                            .expand(7), {
                                                            speedFactor: 0.5
                                                        });
                                                    });
                                                // Remove the previous highlights
                                                if (highlight) {
                                                    highlight.remove();
                                                }
                                                // Highlight the feature passing the objectId to the method
                                                highlight = officeLayerView.highlight(
                                                    [objectId]);
                                            });
                                        container.appendChild(li);
                                    }
                                });
                            }, function () {
                                console.log("zzzinner")
                            });
                    }
                });
            }, function () {
                console.log("zzz")
            });
        });

        scene.then(function () {
            /*********************************************************************
             筛选
             *********************************************************************/

            var foundLayer = scene.layers.find(function (l) {
                return l.title === "xinxi_FFCER";
            });
            console.log(foundLayer);

            on(dojo.query("#edtsd"), "click", function () {
                console.log(foundLayer);
                scene.allLayers.remove(foundLayer);
            });
            on(dojo.query("#jiagai"), "click", function () {
                console.log(foundLayer);
                scene.allLayers.add(foundLayer);
            });
            var buildingQuery = {
                /*"xinxi_FFCER":"College = '信息学院'",
                 "Wall1":"Floor='1'",
                 "Wall1_3D":"Floor='1'",
                 "Wall2":"Floor='2'",
                 "Wall2_3D":"Floor='2'",
                 "Wall3":"Floor='3'",
                 "Wall3_3D":"Floor='3'",
                 "Wall4":"Floor='4'",
                 "Wall4_3D":"Floor='4'",
                 "Wall5":"Floor='5'",
                 "Wall5_3D":"Floor='5'",
                 "Door1":"Floor='1'",
                 "Door1_3D":"Floor='1'",
                 "Door2":"Floor='2'",
                 "Door2_3D":"Floor='2'",
                 "Door3":"Floor='3'",
                 "Door3_3D":"Floor='3'",
                 "Door4":"Floor='4'",
                 "Door4_3D":"Floor='4'",
                 "Door5":"Floor='5'",
                 "Door5_3D":"Floor='5'",
                 "corridor1":"Floor='1'",
                 "corridor2":"Floor='2'",
                 "corridor3":"Floor='3'",
                 "corridor4":"Floor='4'",
                 "corridor5":"Floor='5'",
                 "rooms1":"Floor=1",
                 "rooms2":"Floor=2",
                 "rooms3":"Floor=3",
                 "rooms4":"Floor=4",
                 "rooms5":"Floor=5",*/
            };

            // filter all layers in the web scene to contain only building Q
            scene.layers.forEach(function (layer) {
                console.log("ninininininininininninninini")
                console.log("zzzzzz" + layer.title);
                layer.definitionExpression = buildingQuery[layer.title];
            });

            // we will use the Interior Space layer many times, so we'll save it in a variable
            var officeLayer = scene.layers.find(function (l) {
                console.log(l.title);
                return l.title === "rooms1";
            });
            var officeTypes = [
                "办公室", "实验室",
                "机房", "配电室", "女厕", "男厕"
            ];
            var classroombuildinglayer = scene.layers.find(function (l) {
                console.log(l.title);
                return l.title === "ClassroomBuilding";
            });
            classroombuildinglayer.outFields = ["*"];
            var template = {
                title: "欢迎来到浙江工业大学，这里是{name}",
                // Four fields are used in this template. The value of the selected feature will be
                // inserted in the location of each field name below
                content: "<p>该楼建造于{time},属于{college},{introduce}",
            };

            classroombuildinglayer.popupTemplate = template;


            function displayOfficeTypes() {

                console.log("222")
                // create the query on the officeLayer so that it respects its definitionExpression
                var query = officeLayer.createQuery();

                query.outFields = ["room_type"];
                console.log(query)
                //console.log(officeLayer);
                // query the officeLayer to calculate how many offices are from each type
                officeLayer.queryFeatures(query).then(function (results) {

                    var typesCounter = {}; // counter for the office types defined in the officeTypes array
                    var othersCounter = 0; // counter for all the other office types
                    console.log("111")
                    console.log(results)
                    // count the types of all the features returned from the query
                    results.features.forEach(function (feature) {
                        var spaceType = feature.attributes.room_type;


                        if (typesCounter[spaceType]) {
                            typesCounter[spaceType]++;
                        } else {
                            typesCounter[spaceType] = 1;
                            console.log(typesCounter[spaceType]);
                        }

                        if (officeTypes.indexOf(spaceType) === -1) {
                            othersCounter++;
                        }

                    });

                    // to set the results in the legend, we need to modify the labels in the renderer
                    var newRenderer = officeLayer.renderer.clone();

                    officeTypes.forEach(function (value, i) {
                        newRenderer.uniqueValueInfos[i].label = value +
                            ": " + (typesCounter[value] || 0) + " rooms";
                    });

                    newRenderer.defaultLabel = "Other types: " +
                        othersCounter + " rooms";

                    officeLayer.renderer = newRenderer;
                }, function () {
                    console.log("wwwww")
                });
            }

            displayOfficeTypes();
            /*
             var wall1Layer = scene.layers.find(function(l) {
             console.log(l.title);
             return l.title === "wall1_3D";
             });
             var wall2Layer = scene.layers.find(function(l) {
             console.log(l.title);
             return l.title === "wall2_3D";
             });
             var wall3Layer = scene.layers.find(function(l) {
             console.log(l.title);
             return l.title === "wall3_3D";
             });*/
            // function that will filter by the selected floor
            function showFloors(evt) {

                console.log("floorselecttttt");
                // retrieve the query stored in the selected value
                var floorQuery = evt.target.value;
                /*
                 if(floorQuery === "Floor = '1'"){
                 scene.allLayers.remove(wall2Layer);
                 scene.allLayers.remove(wall3Layer);
                 scene.allLayers.add(wall1Layer);
                 };
                 if(floorQuery === "Floor = '2'"){
                 scene.allLayers.remove(wall1Layer);
                 scene.allLayers.remove(wall3Layer);
                 scene.allLayers.add(wall2Layer);
                 };
                 && layer.title !== "Wall1_3D"&& layer.title !== "Wall2_3D"
                 && layer.title !== "Wall3_3D"
                 && layer.title !== "Wall4_3D"
                 && layer.title !== "Wall5_3D" && layer.title !== "Door1_3D" && layer.title !== "Door2_3D" && layer.title !== "Door3_3D"
                 && layer.title !== "Door4_3D" && layer.title !== "Door5_3D"
                 if(floorQuery === "Floor = '3'"){
                 scene.allLayers.remove(wall2Layer);
                 scene.allLayers.remove(wall1Layer);
                 scene.allLayers.add(wall3Layer);
                 };*/
                // update the definition expression of all layers except the wireframe layer
                scene.layers.forEach(function (layer) {
                    if (layer.title !== "xinxi_FFCER" && layer.title !== "Dormitorys" && layer.title !== "trees1" && layer.title !== "trees_2" && layer.title !== "trees3"
                        && layer.title !== "Light" && layer.title !== "Driveway" && layer.title !== "Walkway" && layer.title !== "river" && layer.title !== "Track"
                        && layer.title !== "Canteen" && layer.title !== "Library_FFCER" && layer.title !== "Pavilion_1" && layer.title !== "ClassroomBuilding"
                        && layer.title !== "ClassroomBuilding" && layer.title !== "Gymnasium1" && layer.title !== "Grass") {
                        if (floorQuery === "Floor = '1'") {
                            layer.definitionExpression = "1=1";
                            if (layer.title !== "Wall1_3D"
                                && layer.title !== "Door1_3D") {
                                console.log("tttttt" + layer.title);
                                console.log(layer);

                                layer.definitionExpression =
                                        /*buildingQuery[layer.title] + " AND " +*/ floorQuery;
                            }
                        } else if (floorQuery === "Floor = '2'") {
                            layer.definitionExpression = "1=1";
                            if (layer.title !== "Wall2_3D"
                                && layer.title !== "Door2_3D") {
                                console.log("tttttt" + layer.title);
                                console.log(layer);

                                layer.definitionExpression =
                                        /*buildingQuery[layer.title] + " AND " +*/ floorQuery;
                            }
                        } else if (floorQuery === "Floor = '3'") {
                            layer.definitionExpression = "1=1";
                            if (layer.title !== "Wall3_3D"
                                && layer.title !== "Door3_3D") {
                                console.log("tttttt" + layer.title);
                                console.log(layer);

                                layer.definitionExpression =
                                        /*buildingQuery[layer.title] + " AND " +*/ floorQuery;
                            }
                        } else if (floorQuery === "Floor = '4'") {
                            layer.definitionExpression = "1=1";
                            if (layer.title !== "Wall4_3D"
                                && layer.title !== "Door4_3D") {
                                console.log("tttttt" + layer.title);
                                console.log(layer);

                                layer.definitionExpression =
                                        /*buildingQuery[layer.title] + " AND " +*/ floorQuery;
                            }
                        } else if (floorQuery === "Floor = '5'") {
                            layer.definitionExpression = "1=1";
                            if (layer.title !== "Wall5_3D"
                                && layer.title !== "Door5_3D") {
                                console.log("tttttt" + layer.title);
                                console.log(layer);

                                layer.definitionExpression =
                                        /*buildingQuery[layer.title] + " AND " +*/ floorQuery;
                            }
                        } else {
                            layer.definitionExpression =
                                    /*buildingQuery[layer.title] + " AND " +*/ floorQuery;
                        }

                    }
                });


                /*scene.layers.forEach(function(layer) {
                 if (layer.title == "Wall1_3D") {
                 console.log("tttttt"+layer.title);
                 console.log("lllll"+layer);
                 console.log(layer);
                 layer.definitionExpression =
                 /!*buildingQuery[layer.title] + " AND " +*!/ floorQuery;
                 }
                 });*/


                // after the layers were filtered recalculate the counts of each office type
                displayOfficeTypes();
            }

            on(dom.byId("floorSelect"), "change", showFloors);


            // add a legend for the officeLayer
            /*var legend = new Legend({
             view: view,
             layerInfos: [{
             layer: officeLayer,
             title: " "
             }],
             container:"shaixuanlend"
             });*/


            // Add a layer list to enable and disable the building wireframe
            var layerList = new LayerList({
                view: view,
                container: "shaixuanright"
            });

        });

        //回到首页
        on(dojo.query("#home"), "click", function () {
            view.goTo({
                    heading: -30, // face due east
                    tilt: 60,
                    center: [120.0421357155, 30.2335793886],
                    scale: 3000,
                },
                {      //这一层大括号就是跟上面类似的Object对象了
                    speedFactor: 0.3,

                });//这个小括号结束的是goTo的范围
        });


        //120.0301730633,30.2231506502, 正大门口1
        //120.0301623344,30.2255609458 图书馆门口2
        //120.0311601162,30.2260893489 理学楼路上3
        //120.0317072868,30.225171594 理学楼abc4
        //120.0322544575,30.2261542403 语林楼5
        //120.0322437286,30.225171594 健行楼6
        //120.0328230858,30.2277857816 广之楼C7
        //120.0341856480,30.2278135917 体育馆8
        //120.0358271599,30.2284810325 枝干路9
        //120.0373935699,30.2275818404 垃圾街10
        //120.0431871414,30.2317162019 新校区门口11
        //120.0423395634,30.2329027130 经过12
        //120.0424683094,30.2339872457 信息学院13
        var options = {
            speedFactor: 0.1, // animation is 10 times slower than default
            duration: 10,
            easing: "in-out-cubic" // easing function to slow down when reaching the target
        };
        var camera1 = Camera({
            heading: 0, // face due east
            tilt: 80,
            position: [
                120.0301730633,
                30.2231506502,
                15,
            ]
        });
        var camera2 = Camera({
            heading: 0,
            tilt: 80,
            position: [
                120.0301623344,
                30.2255609458,
                15,
            ]
        });
        var camera3 = Camera({
            heading: 45,
            tilt: 80,
            position: [
                120.0311601162,
                30.2260893489,
                15,
            ]
        });
        var camera4 = Camera({
            heading: -90,
            tilt: 80,
            position: [
                120.0317072868,
                30.225171594,
                15,
            ]
        });
        var camera5 = Camera({
            heading: 90,
            tilt: 80,
            position: [
                120.0322544575,
                30.2261542403,
                15,
            ]
        });
        var camera6 = Camera({
            heading: -90,
            tilt: 80,
            position: [
                120.0322437286,
                30.2270534454,
                15,
            ]
        });
        var camera7 = Camera({
            heading: 150,
            tilt: 80,
            position: [
                120.0328230858,
                30.2277857816,
                15,
            ]
        });
        var camera8 = Camera({
            heading: 150,
            tilt: 80,
            position: [
                120.0341856480,
                30.2278135917,
                15,
            ]
        });
        var camera9 = Camera({
            heading: 90,
            tilt: 80,
            position: [
                120.0358271599,
                30.2284810325,
                15,
            ]
        });
        var camera10 = Camera({
            heading: 150,
            tilt: 80,
            position: [
                120.0373935699,
                30.2275818404,
                15,
            ]
        });
        var camera11 = Camera({
            heading: 90,
            tilt: 80,
            position: [
                120.0431871414,
                30.2317162019,
                15,
            ]
        });
        var camera12 = Camera({
            heading: 30,
            tilt: 80,
            position: [
                120.0423395634,
                30.2329027130,
                15,
            ]
        });
        var camera13 = Camera({
            heading: 90,
            tilt: 80,
            position: [
                120.0424683094,
                30.2339872457,
                15,
            ]
        });
        on(dojo.query("#intro"), "click", function () {
            view.goTo(camera1, options)
                .then(function () {
                    tourtext.innerHTML = "从正大门出发前往图书馆";
                    return view.goTo(camera2, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往理学楼，理学楼属于理学院，有着数据分析数据挖掘技术专业";
                    return view.goTo(camera3, options);
                })
                .then(function () {

                    return view.goTo(camera4, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往语林楼，语林楼比较文艺，大多数英语试听课都在该楼进行";

                    return view.goTo(camera5, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往健行楼，上课、财务、上机等都在健行";

                    return view.goTo(camera6, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往广之C楼";

                    return view.goTo(camera7, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往体育馆，体育馆分为两个，分别为大小体育馆，大型活动都在这里进行";

                    return view.goTo(camera8, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往支干路，枝干路是教学区和宿舍区的一个分界线，路两边的树很漂亮";

                    return view.goTo(camera9, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往小吃街，小吃街有很多美食";

                    return view.goTo(camera10, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往刚建成的新校区的门口";

                    return view.goTo(camera11, options);
                })
                .then(function () {
                    tourtext.innerHTML = "接下来前往目的地信息学院";
                    return view.goTo(camera12, options);
                })
                .then(function () {
                    tourtext.innerHTML = "信息学院到了，欢迎下次再来";
                    return view.goTo(camera13, options);

                })
                .then(function () {
                    tourtext.innerHTML = "";
                })

        });


        // Add the search widget to the top right corner of the view


    });
</script>

<script>
    $(document).ready(function () {
        $("#daohang").click(function () {
            $("#daohangonetoone").slideToggle("slow");
        });
        $("#bianqian").click(function () {
            $("#slide").slideToggle("slow");
            $("#optionsDiv").css("display", "none");
            $("#shaixuanright").css("display", "none");
            $("#shaixuanlend").css("display", "none");
            $("#gaolianglist").css("display", "none");
        });

        $("#shaixuan").click(function () {
            $("#slide").css("display", "none");
            $("#optionsDiv").css("display", "block");
            $("#shaixuanright").css("display", "block");
            $("#shaixuanlend").css("display", "block");
            $("#gaolianglist").css("display", "none");
        });
        $("#gaoliang").click(function () {
            $("#gaolianglist").css("display", "block");
            $("#optionsDiv").css("display", "none");
            $("#shaixuanright").css("display", "none");
            $("#shaixuanlend").css("display", "none");
            $("#slide").css("display", "none");
        });
        $("#edtsd").click(function () {
            $("#jiagai").css("display", "block");
            $("#edtsd").css("display", "none");

        });
        $("#jiagai").click(function () {
            $("#edtsd").css("display", "block");
            $("#jiagai").css("display", "none");

        });

    });

</script>
<script type="text/javascript">
    function startTime() {
        var today = new Date();
        var h = today.getHours();
        var m = today.getMinutes();
        var s = today.getSeconds();
// add a zero in front of numbers<10
        m = checkTime(m);
        s = checkTime(s);
        document.getElementById('txt').innerHTML = h + ":" + m + ":" + s;
        t = setTimeout('startTime()', 500)
    }

    function checkTime(i) {
        if (i < 10) {
            i = "0" + i
        }
        return i
    }

</script>


<script type="text/javascript">
    var websocket = null;
    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        websocket = new WebSocket("ws://10.12.12.184:8080/websocket");
    }
    else {
        alert('当前浏览器 Not support websocket')
    }

    //连接发生错误的回调方法
    websocket.onerror = function () {
        setMessageInnerHTML("WebSocket连接发生错误");
    };

    //连接成功建立的回调方法
    websocket.onopen = function () {
        setMessageInnerHTML();
    }

    //接收到消息的回调方法
    websocket.onmessage = function (event) {
        var T = event.data.split(",")
        var lat;
        var long;
        var height;
        for (var i = 0; i< T.length; i++) {
        lat=T[0];
        long=T[1];
        height=T[2];
        }
        console.log(lat);
        console.log(long);
        console.log(height);
       setMessageInnerHTML(lat,long,height);
    }

    //连接关闭的回调方法
    websocket.onclose = function () {
        setMessageInnerHTML("WebSocket连接关闭");
    }

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function () {
        closeWebSocket();
    }
   /* function setMessageInnerHTML(long) {
        document.getElementById('message').long += long + '<br/>';*/
    //将消息显示在网页上
    function setMessageInnerHTML(lat,long,height){
        document.getElementById('lat').innerHTML = lat;
        document.getElementById('long').innerHTML = long;
        document.getElementById('height').innerHTML = height;

    }
     /*function setMessageInnerHTML(long,lat,height) {
        document.getElementById('lat').lat = lat + '<br/>';
        document.getElementById('long').long =long  + '<br/>';
        document.getElementById('height').height = height + '<br/>'
    }*/
    //关闭WebSocket连接
    function closeWebSocket() {
        websocket.close();
    }

    //发送消息
    function send() {
        console.log("pp")
        var message = document.getElementById('text').value;
        /* var message1 = document.getElementById('text1').value;
         var message2 = document.getElementById('text2').value;*/
        websocket.send(message);
        /*websocket.send(message1);
         websocket.send(message2);*/
        console.log("message")
    }
</script>


<body onload="startTime()">
<div id="viewDiv"></div>
<div id="overviewDiv">
    <div id="extentDiv"></div>
</div>
<div id="search"></div>
<div id="daohang" class="btn"><i class="icon iconfont icon-jixiao1 fontdh"></i></div>
<div id="daohangonetoone">

</div>
<div id="clock">
    <div id="txt"></div>
</div>
<div id="daohanglan">
    <div id="home" class="btn"><p><i class="icon iconfont icon-shouye fontdhl"></i>主页</p></div>
    <div id="edtsd" class="btn"><p><i class="icon iconfont icon-shouye2 fontdhl"></i>去盖</p></div>
    <div id="jiagai" class="btn"><p><i class="icon iconfont icon-shouye2 fontdhl"></i>加盖</p></div>
    <div id="intro" class="btn"><p><i class="icon iconfont icon-icon fontdhl"></i>介绍</p></div>
    <div id="bianqian" class="btn"><p><i class="icon iconfont icon-icon1 fontdhl"></i>便签</p></div>
    <div id="shaixuan" class="btn"><p><i class="icon iconfont icon-icon2 fontdhl"></i>筛选</p></div>
    <div id="gaoliang" class="btn"><p><i class="icon iconfont icon-shouye4 fontdhl"></i>高亮</p></div>
    <div id="tianjia" class="btn"><p><i class="icon iconfont icon-shouye4 fontdhl"></i>加桌</p></div>
    <div id="jianshao" class="btn"><p><i class="icon iconfont icon-shouye4 fontdhl"></i>减桌</p></div>

</div>
<div id="login" class="btn"><p><i class="icon iconfont icon-shouye1 loginicon" data-toggle="modal"
                                  data-target="#myModal"></i></p></div>
<div id="loginspace">

</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">×
                </button>
                <form class="form-horizontal col-sm-offset-3 col-md-offset-3" id="register_form">
                    <h3 class="form-title">登陆账号</h3>
                    <div class="col-sm-9 col-md-9">
                        <div class="form-group">
                            <h4 class="form-title">选择你的身份：</h4>
                            <select class="selectpicker">
                                <option value="1">学生</option>
                                <option value="2">老师</option>
                                <option value="3">管理员</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <h4 class="form-title">用户名：</h4>
                            <input class="form-control required" type="text" placeholder="Username" name="username"
                                   autofocus="autofocus"/>
                        </div>
                        <div class="form-group">
                            <h4 class="form-title">密码：</h4>
                            <input class="form-control required" type="password" placeholder="Password"
                                   id="register_password" name="password"/>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-default pull-right" data-dismiss="modal">关闭</button>
                            <input type="submit" class="btn btn-success pull-right" value="登陆"/>


                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div id="tourtext"></div>
<div id="slide">
    <div id="createSlideDiv">
        New slide: <input type="text" id="createSlideTitleInput" size="10"/>
        <button id="createSlideButton">Create</button>
    </div>
    <div id="slidesDiv"></div>
</div>
<div id="optionsDiv">
    <div><b>选择需要查看的楼层:</b>
        <select id="floorSelect">
            <option value="1=1">显示楼层</option>
            <option value="Floor = '1'">第一层</option>
            <option value="Floor = '2'">第二层</option>
            <option value="Floor = '3'">第三层</option>
            <option value="Floor = '4'">第四层</option>
            <option value="Floor = '5'">第五层</option>
        </select>
    </div>
</div>
<div id="shaixuanright"></div>
<div id="shaixuanlend"></div>
<div id="gaolianglist" class="panel-side">
    <h2>Office rooms</h2>
    <ul id="roomsList">
        <li>Loading&hellip;</li>
        >
    </ul>
</div>

Welcome<br/>
<button onclick="send()">发送消息</button>
<hr/>
<button onclick="closeWebSocket()">关闭WebSocket连接</button>
<hr/>
   <p>纬度</p><div id="lat"></div>
<p>经度</p><div id="long"></div>
<p>高度</p><div id="height"></div>




<!--<div id="message1" ></div>
<div id="message2" ></div>-->
</body>


</html>